---
title: "GENESIS Nutzungsbericht <br> 2018"
author: "[IT.NRW](https://it.nrw)"
date: "`r Sys.Date()`"
---

```{r setup_packages, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, message = FALSE, warning = FALSE) #Globale Chunk Options
options(scipen=999) # Konfiguration des Zahlenformats

#Skript zum Installieren und Laden der nötigen Pakete
libs <- c("tidyverse", "ggplot2", "ggthemes", "RColorBrewer", "tidytext", "stopwords", "DT", "kableExtra", "highcharter", "lubridate")

for (x in libs){ 
  if(x %in% rownames(installed.packages()) == FALSE) { 
    print(paste0("Installiere ", x, "...")) 
    install.packages(x) 
  } 
  else{ 
    print (paste0(x, " ist bereits installiert")) 
  } 
  library(x, character.only = TRUE) 
} 
```

```{r setup_data, include=FALSE}
#Skript zum Laden der nötigen Daten

#########################Tabellen für Umcodierungen laden
recode_evas <- read_delim("Daten/evas_txt.csv",
                         delim = ";",
                         locale = locale(encoding = "latin1"))
recode_bno <- read_delim("Daten/bno_txt.csv",
                         delim = ";",
                         locale = locale(encoding = "latin1"))
recode_kdtyp <- read_delim("Daten/kdtyp_txt.csv",
                         delim = ";",
                         locale = locale(encoding = "latin1"))
recode_laender <- read_delim("Daten/laender_txt.csv",
                         delim = ";")
recode_indikator <- read_delim("Daten/indikatoren_txt.csv",
                         delim = ";")

#########################Manuelle Stoppwörter für Recherchestatistik laden
#Freie Stoppwörter in die Dateien stoppworte_treffer.csv oder stoppworte_nieten.csv ergänzen. Die Sätze müssen getrennt gepflegt werden. 
#Bei Nieten müssen ggf. "Falsch-Positive" ergänzt werden. Also Wörter die auftauchen, obwohl sie zu Treffern führen (dies kann verschiedene Ursachen haben, die für die Auswertung aber irrelevant sind). 
stoppzusatz_treffer <- read_table("Daten/stoppworte_treffer.csv")
stoppzusatz_nieten <- read_table("Daten/stoppworte_nieten.csv")

#########################Quaderdaten laden - RDB
tab_rdb <- read_delim("Daten/rdb/NSTGOBTTAB.csv",
           delim = ";",#Trennzeichen definieren
           skip = 19,#Quaderkopf abschneiden, hier 19 Zeilen
           col_names = FALSE,
           locale = locale(encoding = "latin1")) %>% #Zeichensatz festlegen
  select(X3, X4, X5, X6, X7, X8, X9, X10, X14) %>% 
  rename(
    tabname = X3,
    abrufart = X4,
    tabtyp = X5,
    rechte = X6,
    kalendertage = X7,
    cached = X8,
    jahr = X9,
    abrufe = X10,
    dauer = X14)

#Datum aus "kalendertag" und "jahr" in eigener Spalte "datum" zusammenführen und formatieren
tab_rdb <- within(tab_rdb, datum <- as.POSIXct(paste(jahr, kalendertage), format = "%Y%m%d"))
#Monat aus Datum im Datumsformat separieren
tab_rdb$monat <- tab_rdb$kalendertage %>% str_sub(1, 2)

#EVAS aus Tabellencodes gewinnen
tab_rdb$EVAS1 <- tab_rdb$tabname %>% str_sub(1, 1)
tab_rdb$EVAS2 <- tab_rdb$tabname %>% str_sub(1, 2)
tab_rdb$EVAS5 <- tab_rdb$tabname %>% str_sub(1, 5)

#EVAS-Bezeichnungen aus recode_evas hinzuspielen
tab_rdb$EVAS1_TXT <- do.call(recode, c(list(tab_rdb$EVAS1), setNames(recode_evas$EVAS1_TXT, recode_evas$EVAS1)))
tab_rdb$EVAS2_TXT <- do.call(recode, c(list(tab_rdb$EVAS2), setNames(recode_evas$EVAS2_TXT, recode_evas$EVAS2)))
tab_rdb$EVAS5_TXT <- do.call(recode, c(list(tab_rdb$EVAS5), setNames(recode_evas$EVAS5_TXT, recode_evas$EVAS5)))

#Abrufart aus recode_bno hinzuspielen
tab_rdb$abrufart <- do.call(recode, c(list(tab_rdb$abrufart), setNames(recode_bno$txt, recode_bno$bno)))

ben_rdb <- read_delim("Daten/rdb/NSTGOBTBEN.csv",
           delim = ";",
           skip = 17,
           col_names = FALSE,
           locale = locale(encoding = "latin1")) %>% 
  select(X3, X4, X5, X6, X7, X8, X12) %>% 
  rename(
    kundentyp = X3,
    werteabruf = X4,
    abrufart = X5,
    kalendertage = X6,
    jahr = X7,
    abrufe = X8,
    dauer = X12)

ben_rdb <- within(ben_rdb, datum <- as.POSIXct(paste(jahr, kalendertage), format = "%Y%m%d"))
ben_rdb$monat <- ben_rdb$kalendertage %>% str_sub(1, 2)

#Kundentypen aus recode_kdtyp hinzuspielen
ben_rdb$kundentyp <- do.call(recode, c(list(ben_rdb$kundentyp), setNames(recode_kdtyp$txt, recode_kdtyp$kdtyp)))

ben_rdb$abrufart <- do.call(recode, c(list(ben_rdb$abrufart), setNames(recode_bno$txt, recode_bno$bno)))

#Labeling von "werteabruf" ohne "Recoding-Tabelle", sonder direkt im Code
ben_rdb$werteabruf <- factor(ben_rdb$werteabruf,levels = c("WA_J", "WA_N"), labels = c("Ja", "Nein"))

#########################Nutzerstatistik laden - RDB
nutzer_rdb <- read_delim("Daten/rdb/nutzerkategorien.csv",
                           delim = ";",#Trennzeichen definieren
                           col_names = TRUE,
                           locale = locale(encoding = "latin1"))#Zeichensatz festlegen

#########################Recherchestatistik laden - RDB
begriffe_rdb <- read_delim("Daten/rdb/begriffe.csv",
                           delim = ";",#Trennzeichen definieren
                           col_names = TRUE,
                           locale = locale(encoding = "latin1"))#Zeichensatz festlegen

#########################Quaderdaten laden - BDB
tab_bdb <- read_delim("Daten/bdb/NSTGOBTTAB.csv",
           delim = ";",
           skip = 19,
           col_names = FALSE,
           locale = locale(encoding = "latin1")) %>%
  select(X3, X4, X5, X6, X7, X8, X9, X10, X14) %>% 
  rename(
    tabname = X3,
    abrufart = X4,
    tabtyp = X5,
    rechte = X6,
    kalendertage = X7,
    cached = X8,
    jahr = X9,
    abrufe = X10,
    dauer = X14)

tab_bdb <- within(tab_bdb, datum <- as.POSIXct(paste(jahr, kalendertage), format = "%Y%m%d"))
tab_bdb$monat <- tab_bdb$kalendertage %>% str_sub(1, 2)
tab_bdb$indikator <- tab_bdb$tabname %>% str_sub(5, 5)
tab_bdb$laender <- tab_bdb$tabname %>% str_sub(1, 2)
tab_bdb$indikator_TXT <- do.call(recode, c(list(tab_bdb$indikator), setNames(recode_indikator$txt, recode_indikator$indikator)))
tab_bdb$laender_TXT <- do.call(recode, c(list(tab_bdb$laender), setNames(recode_laender$txt, recode_laender$laender)))
tab_bdb$abrufart <- do.call(recode, c(list(tab_bdb$abrufart), setNames(recode_bno$txt, recode_bno$bno)))

ben_bdb <- read_delim("Daten/bdb/NSTGOBTBEN.csv",
           delim = ";",
           skip = 17,
           col_names = FALSE,
           locale = locale(encoding = "latin1")) %>% 
  select(X3, X4, X5, X6, X7, X8, X12) %>% 
  rename(
    kundentyp = X3,
    werteabruf = X4,
    abrufart = X5,
    kalendertage = X6,
    jahr = X7,
    abrufe = X8,
    dauer = X12)

ben_bdb <- within(ben_bdb, datum <- as.POSIXct(paste(jahr, kalendertage), format = "%Y%m%d"))
ben_bdb$monat <- ben_bdb$kalendertage %>% str_sub(1, 2)
ben_bdb$kundentyp <- do.call(recode, c(list(ben_bdb$kundentyp), setNames(recode_kdtyp$txt, recode_kdtyp$kdtyp)))
ben_bdb$abrufart <- do.call(recode, c(list(ben_bdb$abrufart), setNames(recode_bno$txt, recode_bno$bno)))
ben_bdb$werteabruf <- factor(ben_bdb$werteabruf,levels = c("WA_J", "WA_N"), labels = c("Ja", "Nein"))

#########################Nutzerstatistik laden - BDB
nutzer_bdb <- read_delim("Daten/bdb/nutzerkategorien.csv",
                           delim = ";",#Trennzeichen definieren
                           col_names = TRUE,
                           locale = locale(encoding = "latin1"))#Zeichensatz festlegen

#########################Recherchestatistik laden - BDB
begriffe_bdb <- read_delim("Daten/bdb/begriffe.csv",
                           delim = ";",
                           col_names = TRUE,
                           locale = locale(encoding = "latin1"))

#########################Quaderdaten laden - LDB
tab_ldb <- read_delim("Daten/ldb/NSTGOBTTAB.csv",
           delim = ";",
           skip = 19,
           col_names = FALSE,
           locale = locale(encoding = "latin1")) %>%
  select(X3, X4, X5, X6, X7, X8, X9, X10, X14) %>% 
  rename(
    tabname = X3,
    abrufart = X4,
    tabtyp = X5,
    rechte = X6,
    kalendertage = X7,
    cached = X8,
    jahr = X9,
    abrufe = X10,
    dauer = X14)

tab_ldb <- within(tab_ldb, datum <- as.POSIXct(paste(jahr, kalendertage), format = "%Y%m%d"))
tab_ldb$monat <- tab_ldb$kalendertage %>% str_sub(1, 2)
tab_ldb$EVAS1 <- tab_ldb$tabname %>% str_sub(1, 1)
tab_ldb$EVAS2 <- tab_ldb$tabname %>% str_sub(1, 2)
tab_ldb$EVAS5 <- tab_ldb$tabname %>% str_sub(1, 5)
tab_ldb$EVAS1_TXT <- do.call(recode, c(list(tab_ldb$EVAS1), setNames(recode_evas$EVAS1_TXT, recode_evas$EVAS1)))
tab_ldb$EVAS2_TXT <- do.call(recode, c(list(tab_ldb$EVAS2), setNames(recode_evas$EVAS2_TXT, recode_evas$EVAS2)))
tab_ldb$EVAS5_TXT <- do.call(recode, c(list(tab_ldb$EVAS5), setNames(recode_evas$EVAS5_TXT, recode_evas$EVAS5)))
tab_ldb$abrufart <- do.call(recode, c(list(tab_ldb$abrufart), setNames(recode_bno$txt, recode_bno$bno)))

ben_ldb <- read_delim("Daten/ldb/NSTGOBTBEN.csv",
           delim = ";",
           skip = 17,
           col_names = FALSE,
           locale = locale(encoding = "latin1")) %>% 
  select(X3, X4, X5, X6, X7, X8, X12) %>% 
  rename(
    kundentyp = X3,
    werteabruf = X4,
    abrufart = X5,
    kalendertage = X6,
    jahr = X7,
    abrufe = X8,
    dauer = X12)

ben_ldb <- within(ben_ldb, datum <- as.POSIXct(paste(jahr, kalendertage), format = "%Y%m%d"))
ben_ldb$monat <- ben_ldb$kalendertage %>% str_sub(1, 2)
ben_ldb$kundentyp <- do.call(recode, c(list(ben_ldb$kundentyp), setNames(recode_kdtyp$txt, recode_kdtyp$kdtyp)))
ben_ldb$abrufart <- do.call(recode, c(list(ben_ldb$abrufart), setNames(recode_bno$txt, recode_bno$bno)))
ben_ldb$werteabruf <- factor(ben_ldb$werteabruf,levels = c("WA_J", "WA_N"), labels = c("Ja", "Nein"))

#########################Nutzerstatistik laden - RDB
nutzer_ldb <- read_delim("Daten/ldb/nutzerkategorien.csv",
                           delim = ";",#Trennzeichen definieren
                           col_names = TRUE,
                           locale = locale(encoding = "latin1"))#Zeichensatz festlegen

#########################Recherchestatistik laden - LDB
begriffe_ldb <- read_delim("Daten/ldb/begriffe.csv",
                           delim = ";",
                           col_names = TRUE,
                           locale = locale(encoding = "latin1"))

#########################Anpassungen für Highcharts
items <- c("downloadPNG", 
           "downloadJPEG", 
           "downloadSVG", 
           "separator", 
           "downloadCSV",
           "downloadXLS", 
           "separator",
           "printChart")
itemDef <- list("printChart" = list(text = "Direkt drucken"),
                "downloadPNG" = list(text = "... als PNG"),
                "downloadJPEG" = list(text = "... als JPEG"),
                "downloadSVG" = list(text = "... als SVG"),
                "downloadCSV" = list(text = "... als CSV"),
                "downloadXLS" = list(text = "... als XLS"))
```

<img src="template/pics/logo.svg" style="position:absolute;top:25px;right:4%;" />

<br>

# Alle GENESIS-Instanzen

## Tabellenabrufe
Der Vergleich zeigt die monatlichen Tabellen-Abrufzahlen ohne interne Client-Abrufe.

```{r abb0, dev='svg'}
cache_rdb <- tab_rdb %>% 
  filter(abrufart != "Client", EVAS1 != "A") %>% 
  group_by(monat) %>%
  summarise(Regionaldatenbank = sum(abrufe))

cache_bdb <- tab_bdb %>% 
  filter(abrufart != "Client" & laender != "99") %>% 
  group_by(monat) %>%
  summarise(Bildungsdatenbank = sum(abrufe))

cache_ldb <- tab_ldb %>% 
  filter(abrufart != "Client") %>% 
  group_by(monat) %>%
  summarise(Landesdatenbank_NRW = sum(abrufe))

cache_join <- left_join(cache_rdb, cache_bdb, by = "monat") %>%
  left_join(., cache_ldb, by = "monat")

cache_join %>% gather("Datenbank", "Anzahl", -monat) %>% 
  mutate(Datenbank = fct_relevel(Datenbank, levels = c("Regionaldatenbank", "Bildungsdatenbank", "Landesdatenbank_NRW"))) %>% 
  hchart(type = "column", hcaes(x = monat, y = Anzahl, group = Datenbank))%>%
  hc_xAxis(title = list(text = "Monat")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Tabellenabrufe")) %>%
  hc_tooltip(crosshairs = TRUE, borderColor = "#446e9b", shared = TRUE, borderWidth = 2, borderRadius = 20, hideDelay = 1000) %>%
  #Anpassung des Highcharts-Export-Buttons, der Funktionen und der Bezeichungen
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Rechercheintensität
Der Vergleich zeigt die arbeitstäglichen Aktivitäten (Begriffssuche) auf den Online-Oberflächen. An den Wochenenden verzeichnen alle Instanzen geringe Aktivitäten, daher werden diese ausgeblendet.

```{r high_vgl, dev='svg'}
begriffe_rdb$jmt <- floor_date(begriffe_rdb$Zeitpunkt, unit = "day")
jmt_rdb <- begriffe_rdb %>% 
  filter(BNO_Art == 3 & year(Zeitpunkt)== 2018) %>% 
  select(ID, jmt) %>% 
  group_by(jmt) %>% 
  summarise(Regionaldatenbank = n_distinct(ID))

begriffe_bdb$jmt <- floor_date(begriffe_bdb$Zeitpunkt, unit = "day")
jmt_bdb <- begriffe_bdb %>% 
  filter(BNO_Art == 3 & year(Zeitpunkt)== 2018) %>% 
  select(ID, jmt) %>% 
  group_by(jmt) %>% 
  summarise(Bildungsdatenbank = n_distinct(ID))

begriffe_ldb$jmt <- floor_date(begriffe_ldb$Zeitpunkt, unit = "day")
jmt_ldb <- begriffe_ldb %>% 
  filter(BNO_Art == 3 & year(Zeitpunkt)== 2018) %>% 
  select(ID, jmt) %>% 
  group_by(jmt) %>% 
  summarise(Landesdatenbank_NRW = n_distinct(ID))


jmt_join <- left_join(jmt_rdb, jmt_bdb, by = "jmt") %>%
  left_join(., jmt_ldb, by = "jmt")

jmt_join %>% gather("Datenbank", "Anzahl", -jmt) %>%  
  mutate(arbeitstag = wday(jmt)) %>% #Identifikation der Wochentage
  filter(arbeitstag %in% c(2:6)) %>% #Ausfiltern der Wochenenden (=1 und 7) zur Glättung der Zeitreihe
  mutate(jmt = datetime_to_timestamp(lubridate::ymd(jmt))) %>% #Zeit-Format nötig für highcharts 
  mutate(Datenbank = fct_relevel(Datenbank, levels = c("Regionaldatenbank", "Bildungsdatenbank", "Landesdatenbank_NRW"))) %>% 
  hchart(type = "line", hcaes(x = jmt, y = Anzahl, group = Datenbank))%>%
  hc_xAxis(type = "datetime", dateTimeLabelFormats = list(jmt = '%d %b'), 
           title = list(text = "Arbeitstage im Jahr <br> <b>nach GENESIS-Instanz:</b>")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Suchbegriffe (Treffer + Nieten)")) %>%
  hc_tooltip(crosshairs = TRUE, borderColor = "#446e9b", shared = TRUE, borderWidth = 2, borderRadius = 20, hideDelay = 1000, sort = TRUE) %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

# Regionaldatenbank Deutschland

## Tabellenabrufe insgesamt {.tabset .tabset-fade .tabset-pills} 
Anzahl der Tabellenabrufe pro Monat nach EVAS-1-Steller und Abrufart

### Diagramm

> Diagrammansicht

```{r abb1_rdb, dev='svg'}
aggregate_tab <- tab_rdb %>% 
  #Ohne Abrufart "Client" und EVAS "A" (themenübergreifende Tabellen des Regionalatlas)
  filter(abrufart != "Client", EVAS1 != "A") %>% 
  #Abrufart umsortieren, damit die höchsten Zahlen links im Diagramm stehen
  mutate(abrufart = fct_relevel(abrufart, c("Online", "Webservice", "Download Area", "Batch"))) %>%
  arrange(abrufart) %>% 
  #Gruppieren zur Summierung der einzelnen Ausprägungskombinationen
  group_by(monat, EVAS1, EVAS1_TXT, abrufart) %>%
  #Summierung der einzelnen Ausprägungskombinationen
  summarise(anzahl = sum(abrufe)) %>% 
  #Gruppierung des Tibbles aufheben
  ungroup()

aggregate_tab %>% 
    ggplot(aes(monat, anzahl, fill = EVAS1_TXT)) +
      geom_bar(stat="identity", width = 0.5) + 
      facet_grid(cols = vars(abrufart)) +
      theme(legend.position="bottom", 
            legend.title = element_blank(), 
            plot.background = element_rect(fill="#FFFFFF"), 
            legend.background = element_rect(fill="#FFFFFF")) +
      guides(fill=guide_legend(ncol=3)) +
      labs(x = "Monat", y = "Anzahl der Datenabrufe") + 
      scale_fill_brewer(palette = "Paired")
```

### Tabelle

> Tabellenansicht

```{r tab1_rdb}
aggregate_tab %>% 
  datatable(filter = "top",
            rownames = FALSE, 
            extensions = "Buttons",
            options = list(pageLength = 12, 
                           dom = "Bftip",
                           initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#446e9b', 'color':       '#fff'});",
                            "}"),
                           buttons = list("copy", "print", 
                                          list(extend = "collection",
                                               buttons = c("csv", "excel"),
                                               text = "Download"))))  %>%
  formatRound("anzahl", digits = 0, interval = 3, mark = ".")#Defintion von NKS und Tausender-Trennzeichen
```

###

## TOP-12-Tabellen

Die am häufigsten abgerufenen Tabellen unabhängig von der Zugangsart, aber ohne interne Client-Abrufe.

```{r abb11_rdb, dev='svg'}
tab_rdb %>% 
  #Ohne Abrufart "Client" und EVAS "A" (themenübergreifende Tabellen des Regionalatlas)
  filter(abrufart != "Client", EVAS1 != "A") %>% 
  select(tabname, abrufe) %>% 
  mutate(tabname_kurz = str_sub(tabname, 1, 11)) %>% #Tabellencode thematisch kürzen
  group_by(tabname_kurz) %>%
  summarise(Anzahl = sum(abrufe)) %>% 
  arrange(desc(Anzahl)) %>% 
  top_n(12) %>% 
  hchart(type = "bar", hcaes(x = tabname_kurz, y = Anzahl))%>%
  hc_xAxis(title = list(text = "Tabellencode")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abrufe")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Bottom-12-Tabellen

Die am seltensten abgerufenen Tabellen unabhängig von der Zugangsart, aber ohne interne Client-Abrufe.

```{r abb12_rdb, dev='svg'}
tab_rdb %>% 
  #Ohne Abrufart "Client" und EVAS "A" (themenübergreifende Tabellen des Regionalatlas)
  filter(abrufart != "Client", EVAS1 != "A", !str_detect(tabname, "TMP")) %>% #TMP-Tabellen rausfiltern
  select(tabname, abrufe) %>% 
  mutate(tabname_kurz = str_sub(tabname, 1, 11)) %>% #Tabellencode thematisch kürzen
  group_by(tabname_kurz) %>%
  summarise(Anzahl = sum(abrufe)) %>% 
  arrange(Anzahl) %>% 
  top_n(-12) %>% #mit - werden die letzten 12 gewählt
  hchart(type = "bar", hcaes(x = tabname_kurz, y = Anzahl))%>%
  hc_xAxis(title = list(text = "Tabellencode")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abrufe")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Nutzer nach Werteabrufen

Anzahl der Online-Nutzer, die entweder einen Werteabruf vorgenommen haben, oder die nur anderweitig recherchiert haben. 

```{r high_rdb, dev='svg'}
ben_rdb %>% 
  mutate(zeitstempel = datetime_to_timestamp(lubridate::ymd(datum))) %>% #Zeit-Format nötig für highcharts 
  select(kundentyp, abrufart, werteabruf, zeitstempel, abrufe) %>% 
  filter(kundentyp == "Gast" & abrufart == "Online") %>% 
  group_by(werteabruf, zeitstempel) %>% 
  summarise(anzahl = sum(abrufe)) %>% 
  
  hchart(type = "line", hcaes(x = zeitstempel, y = anzahl, group = werteabruf))%>%
  hc_xAxis(type = "datetime", dateTimeLabelFormats = list(zeitstempel = '%d %b'), 
           title = list(text = "Tage im Jahr <br> <b>mit Werteabruf:</b>")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Besuche")) %>%
  hc_tooltip(crosshairs = TRUE, borderColor = "#446e9b", shared = TRUE, borderWidth = 2, borderRadius = 20, hideDelay = 1000, sort = TRUE) %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)

```

## Nutzer nach Nutzungsart {.tabset .tabset-fade .tabset-pills}

Anzahl der Nutzer pro Monat nach Nutzerart und Abrufart

### Diagramm

> Diagrammansicht

```{r abb2_rdb, dev='svg'}
aggregate_tab <- ben_rdb %>% 
  select(monat, kundentyp, abrufart, abrufe) %>%
  filter((kundentyp == "Gast" | kundentyp == "Registriert" | kundentyp == "Interner") & (abrufart == "Online" | abrufart == "Webservice" | abrufart == "Download Area" | abrufart == "Batch")) %>% 
  #Abrufart umsortieren, damit die höchsten Zahlen links im Diagramm stehen
  mutate(abrufart = fct_relevel(abrufart, c("Online", "Webservice", "Download Area", "Batch"))) %>%
  mutate(kundentyp = fct_relevel(kundentyp, c("Gast", "Registriert", "Interner"))) %>%
  arrange(abrufart, kundentyp) %>% 
  #Gruppieren zur Summierung der einzelnen Ausprägungskombinationen (Tagesdimension entfernen)
  group_by(monat, kundentyp, abrufart) %>%
  #Summierung der einzelnen Ausprägungskombinationen
  summarise(anzahl = sum(abrufe)) %>% 
  #Gruppierung des Tibbles aufheben
  ungroup()

aggregate_tab %>% 
    ggplot(aes(monat, anzahl, fill = kundentyp)) +
      geom_bar(stat="identity", width = 0.5) + 
      facet_grid(. ~ abrufart) +
      theme(legend.position="bottom", legend.title = element_blank()) +
      labs(x = "Monat", y = "Anzahl der Nutzer") + 
      #Farbwerte aus Colorbrewer Stil "Paired", analog zu oben
      scale_fill_brewer(palette = "Paired")
```

### Tabelle

> Tabellenansicht

```{r tab2_rdb}
aggregate_tab %>% 
  datatable(filter = "top",
            rownames = FALSE, 
            extensions = "Buttons",
            options = list(pageLength = 12, 
                           dom = "Bftip",
                           initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#446e9b', 'color':       '#fff'});",
                            "}"),
                           buttons = list("copy", "print", 
                                          list(extend = "collection",
                                               buttons = c("csv", "excel"),
                                               text = "Download"))))  %>%
  formatRound("anzahl", digits = 0, interval = 3, mark = ".")
```

###

## Nutzer nach Kategorie

Registrierte Nutzer können sich im Zuge der Registrierung einer Nutzerkategorie zuordnen. Dementsprechend gehen Gastnutzer nicht in die Anzahl ein.

```{r nutz_rdb, dev='svg', fig.width=8, fig.height=5}
nutzer_rdb %>% 
  arrange(Anzahl) %>% 
  hchart(type = "pie", hcaes(x = Nutzerkategorie, y = Anzahl))%>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "{point.y} Personen") %>% #Änderung der Tooltips-Layouts und des Inhalts
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Recherchestatistik: Treffer {.tabset .tabset-fade .tabset-pills}
Die häufigsten Suchbegriffe mit Treffern von Nutzern der Online-Oberfläche

### TOP-12

> TOP-12-Ansicht

```{r treffer1_rdb}
#Liste der Stoppwörter aus dem Package "stopwords" erstellen und mit Stoppzusatz verknüpfen
stopp_t <- tibble(word = stopwords("de")) %>% rbind(stoppzusatz_treffer)

treffer <- begriffe_rdb %>% 
  #Selektieren und Reihenfolge der benötigten Variablen
  select(Begriff, Treffer, Zeitpunkt) %>%
  #Treffer filtern (ohne Nieten) und auf Geschäftsjahr beschränken
  filter((Treffer == 1 & year(Zeitpunkt) == 2018))%>%
  #Begriffe trennen und verschiedene Bereinigungen mittels unnest_tokens()
  unnest_tokens(word, Begriff) %>% 
  #Zahlen, Punktationen und 1er/2er-Buchstaben löschen
  mutate(word = gsub(x = word, pattern = "[0-9]+|[[:punct:]]| *\\b[[:alpha:]]{1,2}\\b *", replacement = "")) %>%
  #Fälle mit gelöschten Zahlen und Punktationen entfernen
  filter((word != ""))%>%
  #Stoppwörter entfernen
  anti_join(stopp_t) %>%
  #Wörter zählen und sortieren
  count(word, sort = TRUE) %>% 
  mutate(word = reorder(word, n))

treffer %>% 
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (TOP-12)
  filter(n > 500) %>%
  hchart(type = "bar", hcaes(x = word, y = n))%>%
  hc_xAxis(title = list(text = "Suchbegriffe (Treffer)")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abfragen")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

### Treemap

> Ansicht als Kacheldiagramm

```{r treffer2_rdb}
treffer %>%
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (für gut lesbare Treemap)
  filter(n > 200) %>%
  hchart(type = "treemap", hcaes(x = word, value = n, color = n))
```

###

## Recherchestatistik: Nieten {.tabset .tabset-fade .tabset-pills}
Die häufigsten Suchbegriffe ohne Treffer von Nutzern der Online-Oberfläche

### TOP-12

> TOP-12-Ansicht

```{r nieten1_rdb}
stopp_n <- tibble(word = stopwords("de")) %>% rbind(stoppzusatz_nieten)

nieten <- begriffe_rdb %>% 
  as.tibble() %>%
  select(Begriff, Treffer, Zeitpunkt) %>%
  #Treffer filtern (nur Nieten) und auf Geschäftsjahr beschränken
  filter((Treffer == 0 & year(Zeitpunkt) == 2018)) %>%
  unnest_tokens(word, Begriff) %>% 
  anti_join(stopp_n) %>%
  mutate(word = gsub(x = word, pattern = "[0-9]+|[[:punct:]]| *\\b[[:alpha:]]{1,2}\\b *", replacement = "")) %>%
  filter((word != ""))%>%
  count(word, sort = TRUE)  %>%
  mutate(word = reorder(word, n))

nieten %>% 
  #Minimum für Darstellung definieren - steuert auch die Anzahl der TOP
  filter(n > 68) %>%
  hchart(type = "bar", hcaes(x = word, y = n))%>%
  hc_xAxis(title = list(text = "Suchbegriffe (Nieten)")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abfragen")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

### Treemap

> Ansicht als Kacheldiagramm

```{r nieten2_rdb}
nieten %>%
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (für gut lesbare Treemap)
  filter(n > 40) %>%
  hchart(type = "treemap", hcaes(x = word, value = n, color = n))
```

###

<br>

# Kommunale Bildungsdatenbank

## Tabellenabrufe nach Ländern {.tabset .tabset-fade .tabset-pills} 
Anzahl der Tabellenabrufe pro Monat nach Ländern und Abrufart

### Diagramm

> Diagrammansicht

```{r abb1_bdb, dev='svg'}
aggregate_tab <- tab_bdb %>% 
  filter(abrufart != "Client" & laender != "99") %>% 
  #Abrufart umsortieren, damit die höchsten Zahlen links im Diagramm stehen
  mutate(abrufart = fct_relevel(abrufart, c("Online", "Webservice", "Batch"))) %>%
  arrange(abrufart) %>% 
  #Gruppieren zur Summierung der einzelnen Ausprägungskombinationen
  group_by(monat, laender_TXT, abrufart) %>%
  #Summierung der einzelnen Ausprägungskombinationen
  summarise(anzahl = sum(abrufe)) %>% 
  #Gruppierung des Tibbles aufheben
  ungroup()

farben <- colorRampPalette(brewer.pal(12, "Paired"))(16)#Farbpalette muss für 16 Länder erweitert werden

aggregate_tab %>% 
    ggplot(aes(monat, anzahl, fill = laender_TXT)) +
      geom_bar(stat="identity", width = 0.5) + 
      facet_grid(cols = vars(abrufart)) +
      theme(legend.position="bottom", 
            legend.title = element_blank(), 
            plot.background = element_rect(fill="#FFFFFF"), 
            legend.background = element_rect(fill="#FFFFFF")) +
      guides(fill=guide_legend(ncol=4)) +
      labs(x = "Monat", y = "Anzahl der Datenabrufe") + 
      scale_fill_manual(values = farben)
```

### Tabelle

> Tabellenansicht

```{r tab1_bdb}
aggregate_tab %>% 
  datatable(filter = "top",
            rownames = FALSE, 
            extensions = "Buttons",
            options = list(pageLength = 12, 
                           dom = "Bftip",
                           initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#446e9b', 'color':       '#fff'});",
                            "}"),
                           buttons = list("copy", "print", 
                                          list(extend = "collection",
                                               buttons = c("csv", "excel"),
                                               text = "Download"))))  %>%
  formatRound("anzahl", digits = 0, interval = 3, mark = ".")
```

###

## Tabellenabrufe nach Indikatoren {.tabset .tabset-fade .tabset-pills} 
Anzahl der Tabellenabrufe pro Monat nach Indikatorenbereichen und Abrufart

### Diagramm

> Diagrammansicht

```{r abb1b_bdb, dev='svg'}
aggregate_tab <- tab_bdb %>% 
  filter(abrufart != "Client" & laender != "99") %>% 
  #Abrufart umsortieren, damit die höchsten Zahlen links im Diagramm stehen
  mutate(abrufart = fct_relevel(abrufart, c("Online", "Webservice", "Batch"))) %>%
  arrange(abrufart) %>% 
  mutate(indikator_TXT = fct_relevel(indikator_TXT, c("Rahmenbedingungen", "Frühkindliche Bildung", "Allgemeinbildende Schulen", "Berufliche Bildung","Hochschulen"))) %>%
  arrange(indikator_TXT) %>% 
  #Gruppieren zur Summierung der einzelnen Ausprägungskombinationen
  group_by(monat, indikator_TXT, abrufart) %>%
  #Summierung der einzelnen Ausprägungskombinationen
  summarise(anzahl = sum(abrufe)) %>% 
  #Gruppierung des Tibbles aufheben
  ungroup()

aggregate_tab %>% 
    ggplot(aes(monat, anzahl, fill = indikator_TXT)) +
      geom_bar(stat="identity", width = 0.5) + 
      facet_grid(cols = vars(abrufart)) +
      theme(legend.position="bottom", 
            legend.title = element_blank(), 
            plot.background = element_rect(fill="#FFFFFF"), 
            legend.background = element_rect(fill="#FFFFFF")) +
      guides(fill=guide_legend(ncol=5)) +
      labs(x = "Monat", y = "Anzahl der Datenabrufe") + 
      scale_fill_brewer(palette = "Paired")
```

### Tabelle

> Tabellenansicht

```{r tab1b_bdb}
aggregate_tab %>% 
  datatable(filter = "top",
            rownames = FALSE, 
            extensions = "Buttons",
            options = list(pageLength = 12, 
                           dom = "Bftip",
                           initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#446e9b', 'color':       '#fff'});",
                            "}"),
                           buttons = list("copy", "print", 
                                          list(extend = "collection",
                                               buttons = c("csv", "excel"),
                                               text = "Download"))))  %>%
  formatRound("anzahl", digits = 0, interval = 3, mark = ".")
```

###

## TOP-12-Tabellen

Die am häufigsten abgerufenen Tabellen unabhängig von der Zugangsart, aber ohne interne Client-Abrufe. Aufgrund der speziellen Fachstruktur der Bildungsdatenbank sind keine individuellen, sondern nur nach Kapitel und Land aggregierte Tabellen auswertbar.

```{r abb11_bdb, dev='svg'}
tab_bdb %>% 
  #Ohne Abrufart "Client" und EVAS "A" (themenübergreifende Tabellen des Regionalatlas)
  filter(abrufart != "Client" & laender != "99") %>% 
  select(tabname, abrufe) %>% 
  mutate(tabname_kurz = str_sub(tabname, 1, 5)) %>% #Tabellencode thematisch kürzen
  group_by(tabname_kurz) %>%
  summarise(Anzahl = sum(abrufe)) %>% 
  arrange(desc(Anzahl)) %>% 
  top_n(12) %>% 
  hchart(type = "bar", hcaes(x = tabname_kurz, y = Anzahl))%>%
  hc_xAxis(title = list(text = "Tabellencode")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abrufe")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Bottom-12-Tabellen

Die am seltensten abgerufenen Tabellen unabhängig von der Zugangsart, aber ohne interne Client-Abrufe. Aufgrund der speziellen Fachstruktur der Bildungsdatenbank sind keine individuellen, sondern nur nach Kapitel und Land aggregierte Tabellen auswertbar.

```{r abb12_bdb, dev='svg'}
tab_bdb %>% 
  #Ohne Abrufart "Client" und EVAS "A" (themenübergreifende Tabellen des Regionalatlas)
  filter(abrufart != "Client" & laender != "99") %>% #TMP-Tabellen rausfiltern
  select(tabname, abrufe) %>% 
  mutate(tabname_kurz = str_sub(tabname, 1, 5)) %>% #Tabellencode thematisch kürzen
  group_by(tabname_kurz) %>%
  summarise(Anzahl = sum(abrufe)) %>% 
  arrange(Anzahl) %>% 
  top_n(-12) %>% #mit - werden die letzten 12 gewählt
  hchart(type = "bar", hcaes(x = tabname_kurz, y = Anzahl))%>%
  hc_xAxis(title = list(text = "Tabellencode")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abrufe")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Nutzer nach Werteabrufen

Anzahl der Online-Nutzer, die entweder einen Werteabruf vorgenommen haben, oder die nur anderweitig recherchiert haben.

```{r high_bdb, dev='svg'}
ben_bdb %>% 
  mutate(zeitstempel = datetime_to_timestamp(lubridate::ymd(datum))) %>% #Zeit-Format nötig für highcharts 
  select(kundentyp, abrufart, werteabruf, zeitstempel, abrufe) %>% 
  filter(kundentyp == "Gast" & abrufart == "Online") %>% 
  group_by(werteabruf, zeitstempel) %>% 
  summarise(anzahl = sum(abrufe)) %>% 
  
  hchart(type = "line", hcaes(x = zeitstempel, y = anzahl, group = werteabruf))%>%
  hc_xAxis(type = "datetime", dateTimeLabelFormats = list(zeitstempel = '%d %b'), 
           title = list(text = "Tage im Jahr <br> <b>mit Werteabruf:</b>")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Besuche")) %>%
  hc_tooltip(crosshairs = TRUE, borderColor = "#446e9b", shared = TRUE, borderWidth = 2, borderRadius = 20, hideDelay = 1000, sort = TRUE) %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)

```

## Nutzer nach Nutzungsart{.tabset .tabset-fade .tabset-pills}

Anzahl der Nutzer pro Monat nach Nutzerart und Abrufart

### Diagramm

> Diagrammansicht

```{r abb2_bdb, dev='svg'}
aggregate_tab <- ben_bdb %>% 
  select(monat, kundentyp, abrufart, abrufe) %>%
  filter((kundentyp == "Gast" | kundentyp == "Registriert" | kundentyp == "Interner") & (abrufart == "Online" | abrufart == "Webservice" | abrufart == "Batch")) %>% 
  mutate(abrufart = fct_relevel(abrufart, c("Online", "Webservice", "Batch"))) %>%
  mutate(kundentyp = fct_relevel(kundentyp, c("Gast", "Registriert", "Interner"))) %>%
  arrange(abrufart, kundentyp) %>%  
  #Gruppieren zur Summierung der einzelnen Ausprägungskombinationen (Tagesdimension entfernen)
  group_by(monat, kundentyp, abrufart) %>%
  #Summierung der einzelnen Ausprägungskombinationen
  summarise(anzahl = sum(abrufe)) %>% 
  #Gruppierung des Tibbles aufheben
  ungroup()

aggregate_tab %>% 
    ggplot(aes(monat, anzahl, fill = kundentyp)) +
      geom_bar(stat="identity", width = 0.5) + 
      facet_grid(. ~ abrufart) +
      theme(legend.position="bottom", legend.title = element_blank()) +
      labs(x = "Monat", y = "Anzahl der Nutzer") + 
      #Farbwerte aus Colorbrewer Stil "Paired", analog zu oben
      scale_fill_brewer(palette = "Paired")
```

### Tabelle

> Tabellenansicht

```{r tab2_bdb}
aggregate_tab %>% 
  datatable(filter = "top",
            rownames = FALSE, 
            extensions = "Buttons",
            options = list(pageLength = 12, 
                           dom = "Bftip",
                           initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#446e9b', 'color':       '#fff'});",
                            "}"),
                           buttons = list("copy", "print", 
                                          list(extend = "collection",
                                               buttons = c("csv", "excel"),
                                               text = "Download"))))  %>%
  formatRound("anzahl", digits = 0, interval = 3, mark = ".")
```

###

## Nutzer nach Kategorie

Registrierte Nutzer können sich im Zuge der Registrierung einer Nutzerkategorie zuordnen. Dementsprechend gehen Gastnutzer nicht in die Anzahl ein.

```{r nutz_bdb, dev='svg', fig.width=8, fig.height=5}
nutzer_bdb %>% 
  arrange(Anzahl) %>% 
  hchart(type = "pie", hcaes(x = Nutzerkategorie, y = Anzahl))%>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "{point.y} Personen") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Recherchestatistik: Treffer {.tabset .tabset-fade .tabset-pills}
Die häufigsten Suchbegriffe mit Treffern von Nutzern der Online-Oberfläche

### TOP-12

> TOP-12-Ansicht

```{r treffer1_bdb}
treffer <- begriffe_bdb %>% 
  #Selektieren und Reihenfolge der benötigten Variablen
  select(Begriff, Treffer, Zeitpunkt) %>%
  #Treffer filtern (ohne Nieten) und auf Geschäftsjahr beschränken
  filter((Treffer == 1 & year(Zeitpunkt) == 2018)) %>%
  #Begriffe trennen und verschiedene Bereinigungen mittels unnest_tokens()
  unnest_tokens(word, Begriff) %>% 
  #Zahlen, Punktationen und 1er/2er-Buchstaben löschen
  mutate(word = gsub(x = word, pattern = "[0-9]+|[[:punct:]]| *\\b[[:alpha:]]{1,2}\\b *", replacement = "")) %>%
  #Fälle mit gelöschten Zahlen und Punktationen entfernen
  filter((word != ""))%>%
  #Stoppwörter entfernen
  anti_join(stopp_t) %>%
  #Wörter zählen und sortieren
  count(word, sort = TRUE) %>% 
  mutate(word = reorder(word, n))

treffer %>% 
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (TOP-12)
  filter(n > 70) %>%
  hchart(type = "bar", hcaes(x = word, y = n))%>%
  hc_xAxis(title = list(text = "Suchbegriffe (Treffer)")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abfragen")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

### Treemap

> Ansicht als Kacheldiagramm

```{r treffer2_bdb}
treffer %>%
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (für gut lesbare Treemap)
  filter(n > 20) %>%
  hchart(type = "treemap", hcaes(x = word, value = n, color = n))
```

###

## Recherchestatistik: Nieten {.tabset .tabset-fade .tabset-pills}
Die häufigsten Suchbegriffe ohne Treffer von Nutzern der Online-Oberfläche

### TOP-12

> TOP-12-Ansicht

```{r nieten1_bdb}
nieten <- begriffe_bdb %>% 
  as.tibble() %>%
  select(Begriff, Treffer, Zeitpunkt) %>%
  #Treffer filtern (nur Nieten) und auf Geschäftsjahr beschränken
  filter((Treffer == 0 & year(Zeitpunkt) == 2018)) %>%
  unnest_tokens(word, Begriff) %>% 
  mutate(word = gsub(x = word, pattern = "[0-9]+|[[:punct:]]| *\\b[[:alpha:]]{1,2}\\b *", replacement = "")) %>%
  filter((word != ""))%>%
  anti_join(stopp_n) %>%
  count(word, sort = TRUE)  %>%
  mutate(word = reorder(word, n))

nieten %>% 
  #Minimum für Darstellung definieren - steuert auch die Anzahl der TOP
  filter(n > 9) %>%
  hchart(type = "bar", hcaes(x = word, y = n))%>%
  hc_xAxis(title = list(text = "Suchbegriffe (Nieten)")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abfragen")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

### Treemap

> Ansicht als Kacheldiagramm

```{r nieten2_bdb}
nieten %>%
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (für gut lesbare Treemap)
  filter(n > 5) %>%
  hchart(type = "treemap", hcaes(x = word, value = n, color = n))
```

###

<br>

# Landesdatenbank NRW

## Tabellenabrufe insgesamt {.tabset .tabset-fade .tabset-pills} 
Anzahl der Tabellenabrufe pro Monat nach EVAS-1-Steller und Abrufart

### Diagramm

> Diagrammansicht

```{r abb1_ldb, dev='svg'}
aggregate_tab <- tab_ldb %>% 
  #Ohne Abrufart "Client" und EVAS "A" (themenübergreidende Tabellen des Regionalatlas)
  filter(abrufart != "Client") %>% 
  #Abrufart umsortieren, damit die höchsten Zahlen links im Diagramm stehen
  mutate(abrufart = fct_relevel(abrufart, c("Online", "Webservice", "Batch"))) %>%
  arrange(abrufart) %>% 
  #Gruppieren zur Summierung der einzelnen Ausprägungskombinationen
  group_by(monat, EVAS1, EVAS1_TXT, abrufart) %>%
  #Summierung der einzelnen Ausprägungskombinationen
  summarise(anzahl = sum(abrufe)) %>% 
  #Gruppierung des Tibbles aufheben
  ungroup()

aggregate_tab %>% 
    ggplot(aes(monat, anzahl, fill = EVAS1_TXT)) +
      geom_bar(stat="identity", width = 0.5) + 
      facet_grid(cols = vars(abrufart)) +
      theme(legend.position="bottom", 
            legend.title = element_blank(), 
            plot.background = element_rect(fill="#FFFFFF"), 
            legend.background = element_rect(fill="#FFFFFF")) +
      guides(fill=guide_legend(ncol=3)) +
      labs(x = "Monat", y = "Anzahl der Datenabrufe") + 
      scale_fill_brewer(palette = "Paired")
```

### Tabelle

> Tabellenansicht

```{r tab1_ldb}
aggregate_tab %>% 
  datatable(filter = "top",
            rownames = FALSE, 
            extensions = "Buttons",
            options = list(pageLength = 12, 
                           dom = "Bftip",
                           initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#446e9b', 'color':       '#fff'});",
                            "}"),
                           buttons = list("copy", "print", 
                                          list(extend = "collection",
                                               buttons = c("csv", "excel"),
                                               text = "Download"))))  %>%
  formatRound("anzahl", digits = 0, interval = 3, mark = ".")
```

###

## TOP-12-Tabellen

Die am häufigsten abgerufenen Tabellen unabhängig von der Zugangsart, aber ohne interne Client-Abrufe.

```{r abb11_ldb, dev='svg'}
tab_ldb %>% 
  filter(abrufart != "Client" & EVAS1 != "9" & !str_detect(tabname, "XXX")) %>% #XXX-Tabellen rausfiltern
  select(tabname, abrufe) %>% 
  mutate(tabname_kurz = str_sub(tabname, 1, 11)) %>% 
  group_by(tabname_kurz) %>%
  summarise(Anzahl = sum(abrufe)) %>% 
  arrange(desc(Anzahl)) %>% 
  top_n(12) %>% 
  hchart(type = "bar", hcaes(x = tabname_kurz, y = Anzahl))%>%
  hc_xAxis(title = list(text = "Tabellencode")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abrufe")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Bottom-12-Tabellen

Die am seltensten abgerufenen Tabellen unabhängig von der Zugangsart, aber ohne interne Client-Abrufe.

**Entfällt.** Die Landesdatenbank NRW bietet eine große Anzahl Tabellen an, die im Berichtsjahr selten abgerufen worden sind. Eine Auswertung ist derzeit nicht als Bottom-12 darstellbar.

## Nutzer nach Werteabrufen

Anzahl der Online-Nutzer, die entweder einen Werteabruf vorgenommen haben, oder die nur anderweitig recherchiert haben.

```{r high_ldb, dev='svg'}
ben_ldb %>% 
  mutate(zeitstempel = datetime_to_timestamp(lubridate::ymd(datum))) %>% #Zeit-Format nötig für highcharts 
  select(kundentyp, abrufart, werteabruf, zeitstempel, abrufe) %>% 
  filter(kundentyp == "Gast" & abrufart == "Online") %>% 
  group_by(werteabruf, zeitstempel) %>% 
  summarise(anzahl = sum(abrufe)) %>% 
  
  hchart(type = "line", hcaes(x = zeitstempel, y = anzahl, group = werteabruf))%>%
  hc_xAxis(type = "datetime", dateTimeLabelFormats = list(zeitstempel = '%d %b'), 
           title = list(text = "Tage im Jahr <br> <b>mit Werteabruf:</b>")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Besuche")) %>%
  hc_tooltip(crosshairs = TRUE, borderColor = "#446e9b", shared = TRUE, borderWidth = 2, borderRadius = 20, hideDelay = 1000, sort = TRUE) %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)

```

## Nutzer nach Nutzungsart{.tabset .tabset-fade .tabset-pills}

Anzahl der Nutzer pro Monat nach Nutzerart und Abrufart

### Diagramm

> Diagrammansicht

```{r abb2_ldb, dev='svg'}
aggregate_tab <- ben_ldb %>% 
  select(monat, kundentyp, abrufart, abrufe) %>%
  filter((kundentyp == "Gast" | kundentyp == "Registriert" | kundentyp == "Interner") & (abrufart == "Online" | abrufart == "Webservice" | abrufart == "Batch")) %>% 
  #Abrufart umsortieren, damit die höchsten Zahlen links im Diagramm stehen
  mutate(abrufart = fct_relevel(abrufart, c("Online", "Webservice", "Batch"))) %>%
  mutate(kundentyp = fct_relevel(kundentyp, c("Gast", "Registriert", "Interner"))) %>%
  arrange(abrufart, kundentyp) %>%   
  #Gruppieren zur Summierung der einzelnen Ausprägungskombinationen (Tagesdimension entfernen)
  group_by(monat, kundentyp, abrufart) %>%
  #Summierung der einzelnen Ausprägungskombinationen
  summarise(anzahl = sum(abrufe)) %>% 
  #Gruppierung des Tibbles aufheben
  ungroup()

aggregate_tab %>% 
    ggplot(aes(monat, anzahl, fill = kundentyp)) +
      geom_bar(stat="identity", width = 0.5) + 
      facet_grid(. ~ abrufart) +
      theme(legend.position="bottom", legend.title = element_blank()) +
      labs(x = "Monat", y = "Anzahl der Nutzer") + 
      #Farbwerte aus Colorbrewer Stil "Paired", analog zu oben
      scale_fill_brewer(palette = "Paired")
```

### Tabelle

> Tabellenansicht

```{r tab2_ldb}
aggregate_tab %>% 
  datatable(filter = "top",
            rownames = FALSE, 
            extensions = "Buttons",
            options = list(pageLength = 12, 
                           dom = "Bftip",
                           initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#446e9b', 'color':       '#fff'});",
                            "}"),
                           buttons = list("copy", "print", 
                                          list(extend = "collection",
                                               buttons = c("csv", "excel"),
                                               text = "Download"))))  %>%
  formatRound("anzahl", digits = 0, interval = 3, mark = ".")
```

###

## Nutzer nach Kategorie

Registrierte Nutzer können sich im Zuge der Registrierung einer Nutzerkategorie zuordnen. Dementsprechend gehen Gastnutzer nicht in die Anzahl ein.

```{r nutz_ldb, dev='svg', fig.width=8, fig.height=5}
nutzer_ldb %>% 
  arrange(Anzahl) %>% 
  hchart(type = "pie", hcaes(x = Nutzerkategorie, y = Anzahl))%>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "{point.y} Personen") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

## Recherchestatistik: Treffer {.tabset .tabset-fade .tabset-pills}
Die häufigsten Suchbegriffe mit Treffern von Nutzern der Online-Oberfläche

### TOP-12

> TOP-12-Ansicht

```{r treffer1_ldb}
treffer <- begriffe_ldb %>% 
  #Selektieren und Reihenfolge der benötigten Variablen
  select(Begriff, Treffer, Zeitpunkt) %>%
  #Treffer filtern (ohne Nieten) und auf Geschäftsjahr beschränken
  filter((Treffer == 1 & year(Zeitpunkt) == 2018))%>%
  #Begriffe trennen und verschiedene Bereinigungen mittels unnest_tokens()
  unnest_tokens(word, Begriff) %>% 
  #Zahlen, Punktationen und 1er/2er-Buchstaben löschen
  mutate(word = gsub(x = word, pattern = "[0-9]+|[[:punct:]]| *\\b[[:alpha:]]{1,2}\\b *", replacement = "")) %>%
  #Fälle mit gelöschten Zahlen und Punktationen entfernen
  filter((word != ""))%>%
  #Stoppwörter entfernen
  anti_join(stopp_t) %>%
  #Wörter zählen und sortieren
  count(word, sort = TRUE) %>% 
  mutate(word = reorder(word, n))

treffer %>% 
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (TOP-12)
  filter(n > 285) %>%
  hchart(type = "bar", hcaes(x = word, y = n))%>%
  hc_xAxis(title = list(text = "Suchbegriffe (Treffer)")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abfragen")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

### Treemap

> Ansicht als Kacheldiagramm

```{r treffer2_ldb}
treffer %>%
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (für gut lesbare Treemap)
  filter(n > 90) %>%
  hchart(type = "treemap", hcaes(x = word, value = n, color = n))
```

###

## Recherchestatistik: Nieten {.tabset .tabset-fade .tabset-pills}
Die häufigsten Suchbegriffe ohne Treffer von Nutzern der Online-Oberfläche

### TOP-12

> TOP-12-Ansicht

```{r nieten1_ldb}
nieten <- begriffe_ldb %>% 
  as.tibble() %>%
  select(Begriff, Treffer, Zeitpunkt) %>%
  #Treffer filtern (nur Nieten) und auf Geschäftsjahr beschränken
  filter((Treffer == 0 & year(Zeitpunkt) == 2018)) %>%
  unnest_tokens(word, Begriff) %>% 
  mutate(word = gsub(x = word, pattern = "[0-9]+|[[:punct:]]| *\\b[[:alpha:]]{1,2}\\b *", replacement = "")) %>%
  filter((word != ""))%>%
  anti_join(stopp_n) %>%
  count(word, sort = TRUE)  %>%
  mutate(word = reorder(word, n))

nieten %>% 
  #Minimum für Darstellung definieren - steuert auch die Anzahl der TOP
  filter(n > 65) %>%
  hchart(type = "bar", hcaes(x = word, y = n))%>%
  hc_xAxis(title = list(text = "Suchbegriffe (Nieten)")) %>% 
  hc_yAxis(title = list(text = "Anzahl der Abfragen")) %>%
  hc_tooltip(borderColor = "#446e9b", borderWidth = 2, borderRadius = 20, hideDelay = 1000, pointFormat = "Anzahl: {point.y}") %>%
  hc_exporting(enabled = TRUE,
               buttons = list(contextButton = list(text = "Export", symbolStroke = "#446e9b",
                                                   menuItems = items)),
               menuItemDefinitions = itemDef)
```

### Treemap

> Ansicht als Kacheldiagramm

```{r nieten2_ldb}
nieten %>%
  #Minimum für Darstellung definieren - steuert auch die Anzahl der Begriffe (für gut lesbare Treemap)
  filter(n > 25) %>%
  hchart(type = "treemap", hcaes(x = word, value = n, color = n))
```

###

<br>

# Anlage: Nutzungshinweise
* Nur für den internen Gebrauch im statistischen Verbund. Nicht zur Veröffentlichung bestimmt.
* **Für Rückfragen:**  
IT.NRW, Referat 541 * Fachübergreifende statistische Informationssysteme  
Tel.: +49 211 9449-2523  
Mail: [LDB-Redaktion](mailto:ldb-redaktion@it.nrw.de)

# Anlage: Technische Hinweise

```{r appendix}
sessionInfo()
```